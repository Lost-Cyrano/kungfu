<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .scroller {
            height: 100vh;
            overflow-y: auto;
            padding: 10px;
        }

        .category {
            background: white;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .category-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 16px 20px;
            font-size: 1.2em;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .athlete {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: white;
            transition: background 0.2s;
        }

        .athlete:hover {
            background: #f9f9f9;
        }

        .athlete:last-child {
            border-bottom: none;
        }

        .athlete-info {
            flex: 1;
            min-width: 0;
        }

        .athlete-name {
            font-weight: 500;
            font-size: 1.1em;
            color: #333;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .athlete-status {
            font-size: 0.85em;
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 8px;
        }

        .status-waiting {
            background: #fff3cd;
            color: #856404;
        }

        .status-active {
            background: #d1ecf1;
            color: #0c5460;
        }

        .status-done {
            background: #d4edda;
            color: #155724;
        }

        .notes-container {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            min-width: 300px;
        }

        .note-input {
            width: 80px;
            padding: 8px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            text-align: center;
            transition: all 0.2s;
        }

        .note-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .add-note-btn {
            background: #667eea;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s;
        }

        .add-note-btn:hover {
            background: #5a6fd8;
        }

        .notes-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }

        .note-badge {
            background: #e8f4fc;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9em;
            color: #2c5282;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .note-value {
            font-weight: 600;
        }

        .delete-note-btn {
            background: none;
            border: none;
            color: #666;
            cursor: pointer;
            font-size: 0.8em;
            padding: 2px;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .delete-note-btn:hover {
            background: rgba(255, 0, 0, 0.1);
            color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .current-round {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="scroller" id="scroller">
        <div class="loading" id="loading">Chargement...</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <script>
        const firebaseConfig = {
            databaseURL: "https://kungfusete-default-rtdb.europe-west1.firebasedatabase.app/"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let categoriesData = {};

        function createAthleteElement(athlete, categoryId) {
            const athleteDiv = document.createElement('div');
            athleteDiv.className = 'athlete';
            athleteDiv.dataset.id = athlete.id;
            athleteDiv.dataset.category = categoryId;

            const athleteInfo = document.createElement('div');
            athleteInfo.className = 'athlete-info';
            
            const nameDiv = document.createElement('div');
            nameDiv.className = 'athlete-name';
            nameDiv.textContent = athlete.name;
            
            const statusDiv = document.createElement('span');
            statusDiv.className = `athlete-status status-${athlete.status || 'waiting'}`;
            statusDiv.textContent = athlete.status === 'en_cours' ? 'En cours' : 
                                  athlete.status === 'termine' ? 'Terminé' : 'En attente';
            
            const roundDiv = document.createElement('div');
            roundDiv.className = 'current-round';
            roundDiv.textContent = `Round ${athlete.currentRound || 1}`;
            
            athleteInfo.appendChild(nameDiv);
            athleteInfo.appendChild(statusDiv);
            athleteInfo.appendChild(roundDiv);
            
            const notesContainer = document.createElement('div');
            notesContainer.className = 'notes-container';
            
            const notesList = document.createElement('div');
            notesList.className = 'notes-list';
            
            if (athlete.notes) {
                Object.entries(athlete.notes).forEach(([noteId, noteValue]) => {
                    if (noteValue !== null && noteValue !== '') {
                        const noteBadge = document.createElement('div');
                        noteBadge.className = 'note-badge';
                        noteBadge.dataset.noteId = noteId;
                        
                        const noteSpan = document.createElement('span');
                        noteSpan.className = 'note-value';
                        noteSpan.textContent = noteValue;
                        
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-note-btn';
                        deleteBtn.innerHTML = '×';
                        deleteBtn.onclick = () => deleteNote(categoryId, athlete.id, noteId);
                        
                        noteBadge.appendChild(noteSpan);
                        noteBadge.appendChild(deleteBtn);
                        notesList.appendChild(noteBadge);
                    }
                });
            }
            
            const input = document.createElement('input');
            input.className = 'note-input';
            input.type = 'number';
            input.min = '0';
            input.max = '10';
            input.step = '0.1';
            input.placeholder = 'Note';
            
            const addBtn = document.createElement('button');
            addBtn.className = 'add-note-btn';
            addBtn.innerHTML = '+';
            addBtn.onclick = () => addNote(categoryId, athlete.id, input);
            
            notesContainer.appendChild(notesList);
            notesContainer.appendChild(input);
            notesContainer.appendChild(addBtn);
            
            athleteDiv.appendChild(athleteInfo);
            athleteDiv.appendChild(notesContainer);
            
            return athleteDiv;
        }

        function addNote(categoryId, athleteId, inputElement) {
            const value = parseFloat(inputElement.value);
            if (isNaN(value) || value < 0 || value > 10) return;
            
            const noteId = `note_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            const noteRef = database.ref(`/categories/${categoryId}/athletes`)
                .orderByChild('id')
                .equalTo(athleteId);
            
            noteRef.once('value').then(snapshot => {
                snapshot.forEach(childSnapshot => {
                    const athleteRef = childSnapshot.ref;
                    athleteRef.child(`notes/${noteId}`).set(value);
                });
            });
            
            inputElement.value = '';
        }

        function deleteNote(categoryId, athleteId, noteId) {
            const noteRef = database.ref(`/categories/${categoryId}/athletes`)
                .orderByChild('id')
                .equalTo(athleteId);
            
            noteRef.once('value').then(snapshot => {
                snapshot.forEach(childSnapshot => {
                    childSnapshot.ref.child(`notes/${noteId}`).remove();
                });
            });
        }

        function updateAthleteDisplay(categoryId, athlete) {
            const athleteElement = document.querySelector(`.athlete[data-id="${athlete.id}"][data-category="${categoryId}"]`);
            if (athleteElement) {
                const newElement = createAthleteElement(athlete, categoryId);
                athleteElement.parentNode.replaceChild(newElement, athleteElement);
            }
        }

        function renderCategories(categories) {
            const scroller = document.getElementById('scroller');
            scroller.innerHTML = '';
            
            if (!categories || Object.keys(categories).length === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';
                emptyState.textContent = 'Aucune catégorie disponible';
                scroller.appendChild(emptyState);
                return;
            }
            
            const sortedCategories = Object.entries(categories)
                .sort(([, a], [, b]) => (a.order || 0) - (b.order || 0));
            
            sortedCategories.forEach(([categoryId, category]) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'category';
                
                const header = document.createElement('div');
                header.className = 'category-header';
                header.textContent = category.name;
                
                const athletesList = document.createElement('div');
                
                if (category.athletes && category.athletes.length > 0) {
                    const sortedAthletes = [...category.athletes].sort((a, b) => (a.order || 0) - (b.order || 0));
                    sortedAthletes.forEach(athlete => {
                        athletesList.appendChild(createAthleteElement(athlete, categoryId));
                    });
                }
                
                categoryDiv.appendChild(header);
                categoryDiv.appendChild(athletesList);
                scroller.appendChild(categoryDiv);
            });
        }

        function listenForChanges() {
            database.ref('/categories').on('value', (snapshot) => {
                document.getElementById('loading').style.display = 'none';
                categoriesData = snapshot.val() || {};
                renderCategories(categoriesData);
            });
        }

        window.onload = () => {
            listenForChanges();
        };
    </script>
</body>
</html>
